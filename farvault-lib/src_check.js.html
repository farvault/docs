<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/check.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/farvault/farvault-lib" target="_blank" class="menu-item" id="repository" >Farvault-lib Github repo</a></h2><h3>Classes</h3><ul><li><a href="Discovery.html">Discovery</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Discovery.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#fetchUtxos">fetchUtxos</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#getAccounts">getAccounts</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#getFundedDerivationPaths">getFundedDerivationPaths</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#getNetworkIds">getNetworkIds</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#getUsedDerivationPaths">getUsedDerivationPaths</a></li><li data-type='method' style='display: none;'><a href="Discovery.html#getUtxos">getUtxos</a></li></ul></li><li><a href="HDInterface.html">HDInterface</a><ul class='methods'><li data-type='method' style='display: none;'><a href="HDInterface.html#close">close</a></li><li data-type='method' style='display: none;'><a href="HDInterface.html#createSigners">createSigners</a></li><li data-type='method' style='display: none;'><a href="HDInterface.html#getExtPub">getExtPub</a></li><li data-type='method' style='display: none;'><a href="HDInterface.html#getPublicKey">getPublicKey</a></li><li data-type='method' style='display: none;'><a href="HDInterface.html#init">init</a></li></ul></li><li><a href="LedgerHDInterface.html">LedgerHDInterface</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LedgerHDInterface.html#close">close</a></li><li data-type='method' style='display: none;'><a href="LedgerHDInterface.html#createSigners">createSigners</a></li><li data-type='method' style='display: none;'><a href="LedgerHDInterface.html#getExtPub">getExtPub</a></li><li data-type='method' style='display: none;'><a href="LedgerHDInterface.html#init">init</a></li></ul></li><li><a href="SoftHDInterface.html">SoftHDInterface</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SoftHDInterface.html#createSigners">createSigners</a></li><li data-type='method' style='display: none;'><a href="SoftHDInterface.html#getExtPub">getExtPub</a></li><li data-type='method' style='display: none;'><a href="SoftHDInterface.html#init">init</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-bip44.html">bip44</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-bip44.html#.deriveExtPub">deriveExtPub</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#.getDerivationPathAddress">getDerivationPathAddress</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#.getExtPubAddress">getExtPubAddress</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#.parseDerivationPath">parseDerivationPath</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#.serializeDerivationPath">serializeDerivationPath</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#.setExtPubPrefix">setExtPubPrefix</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#~getExtPubAccountNumber">getExtPubAccountNumber</a></li><li data-type='method' style='display: none;'><a href="module-bip44.html#~getExtPubPurpose">getExtPubPurpose</a></li></ul></li><li><a href="module-bip44_chain.html">bip44/chain</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-bip44_chain.html#.getNextDerivationPath">getNextDerivationPath</a></li><li data-type='method' style='display: none;'><a href="module-bip44_chain.html#~getDefaultAccount">getDefaultAccount</a></li><li data-type='method' style='display: none;'><a href="module-bip44_chain.html#~getLastDerivationPath">getLastDerivationPath</a></li><li data-type='method' style='display: none;'><a href="module-bip44_chain.html#~normalizeDerivationPaths">normalizeDerivationPaths</a></li></ul></li><li><a href="module-check.html">check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-check.html#.checkAddress">checkAddress</a></li><li data-type='method' style='display: none;'><a href="module-check.html#.checkExtPub">checkExtPub</a></li><li data-type='method' style='display: none;'><a href="module-check.html#.checkFeeEstimates">checkFeeEstimates</a></li><li data-type='method' style='display: none;'><a href="module-check.html#.checkNetwork">checkNetwork</a></li><li data-type='method' style='display: none;'><a href="module-check.html#.checkPurpose">checkPurpose</a></li></ul></li><li><a href="module-coinselect.html">coinselect</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-coinselect.html#.coinselect">coinselect</a></li></ul></li><li><a href="module-dataFetchers.html">dataFetchers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.blockstreamFetchAddress">blockstreamFetchAddress</a></li><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.blockstreamFetchFeeEstimates">blockstreamFetchFeeEstimates</a></li><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.blockstreamFetchUtxos">blockstreamFetchUtxos</a></li><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.esploraFetchAddress">esploraFetchAddress</a></li><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.esploraFetchFeeEstimates">esploraFetchFeeEstimates</a></li><li data-type='method' style='display: none;'><a href="module-dataFetchers.html#.esploraFetchUtxos">esploraFetchUtxos</a></li></ul></li><li><a href="module-fees.html">fees</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-fees.html#.feeRateSampling">feeRateSampling</a></li><li data-type='method' style='display: none;'><a href="module-fees.html#.pickEsploraFeeEstimate">pickEsploraFeeEstimate</a></li></ul></li><li><a href="module-networks.html">networks</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-networks.html#.networks">networks</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-networks.html#.getNetworkCoinType">getNetworkCoinType</a></li></ul></li><li><a href="module-scripts.html">scripts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-scripts.html#.createRelativeTimeLockScript">createRelativeTimeLockScript</a></li><li data-type='method' style='display: none;'><a href="module-scripts.html#.parseRelativeTimeLockScript">parseRelativeTimeLockScript</a></li><li data-type='method' style='display: none;'><a href="module-scripts.html#.unlockScript">unlockScript</a></li><li data-type='method' style='display: none;'><a href="module-scripts.html#~numberEncodeAsm">numberEncodeAsm</a></li><li data-type='method' style='display: none;'><a href="module-scripts.html#~scriptNumberDecode">scriptNumberDecode</a></li></ul></li><li><a href="module-test.html">test</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-test.html#.fundRegtest">fundRegtest</a></li></ul></li><li><a href="module-transactions.html">transactions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-transactions.html#.createMultiFeeTransactions">createMultiFeeTransactions</a></li><li data-type='method' style='display: none;'><a href="module-transactions.html#.createTransaction">createTransaction</a></li><li data-type='method' style='display: none;'><a href="module-transactions.html#~createPSBT">createPSBT</a></li><li data-type='method' style='display: none;'><a href="module-transactions.html#~witnessStackToScriptWitness">witnessStackToScriptWitness</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#createFixture">createFixture</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/check.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module check */

import {
  XPUB,
  YPUB,
  ZPUB,
  TPUB,
  UPUB,
  VPUB,
  EXTENDEDPUBTYPES,
  LEGACY,
  NESTED_SEGWIT,
  NATIVE_SEGWIT,
  PUBVERSIONSIZE,
  PUBVERSIONS,
  PURPOSES
} from './constants';

//import { P2PKH, P2WPKH, P2SH_P2WPKH } from './accounts';

import { address as bjsAddress } from 'bitcoinjs-lib';
import { networks, getNetworkCoinType, getNetworkId } from './networks';

import BIP32Factory from 'bip32';
import * as ecc from './secp256k1';
let bjsBip32;
if (typeof ecc === 'object' &amp;&amp; typeof ecc.then === 'function') {
  (async () => {
    //webpack modules will load WASM asynchronously. Node won't.
    bjsBip32 = BIP32Factory(await ecc);
  })();
} else {
  bjsBip32 = BIP32Factory(ecc);
}

import b58 from 'bs58check';

/**
 * Throws an error if the network not valid.
 * @param {Object} network A {@link module:networks.networks network}.
 * @param {boolean} [includeRegtest=true] Include regtest in the pool of possible networks. Default is true.
 * @returns {boolean} If the function does not throw, then it always returns true.
 */
export function checkNetwork(network, includeRegtest = true) {
  if (includeRegtest) {
    if (
      typeof network !== 'object' ||
      (network !== networks.bitcoin &amp;&amp;
        network !== networks.testnet &amp;&amp;
        network !== networks.regtest &amp;&amp;
        network !== networks.signet)
    )
      throw new Error('Network must be mainnet, testnet, signet or regtest');
  } else {
    if (
      network !== networks.bitcoin &amp;&amp;
      network !== networks.testnet &amp;&amp;
      network !== networks.signet
    )
      throw new Error('Network must be mainnet, signet or testnet');
  }
  return true;
}
/**
 * Throws an error if the purpose not valid.
 * @param {srting} purpose LEGACY, NATIVE_SEGWIT or NESTED_SEGWIT
 * @returns {boolean} If the function does not throw, then it always returns true.
 */
export function checkPurpose(purpose) {
  if (
    typeof purpose !== 'number' ||
    (purpose === LEGACY ||
      purpose === NESTED_SEGWIT ||
      purpose === NATIVE_SEGWIT) === false
  )
    throw new Error('Invalid purpose!');
  return true;
}

/**
 * Throws an error if any of the following checks are not fulfilled:
 *
 * * Makes sure the extPub corresponds to the network.
 * * Makes sure it can be correctly decoded (using npm's bip32.fromBase58).
 * * Makes sure it has depth: 3 (conforms to BIP44, BIP49 &amp; BIP84).
 * * It checks whether its coin type meets one of the supported networks:
 * Bitcoin mainnet, testnet, signet or regtest.
 * * Optionally pass an accountNumber to check it's the one encoded in the extPub.
 * * Optionally pass a coinType (0 Bitcoin, 1 Testnet &amp;  Regtest, ...) and checks
 * whether it belongs to the network (if passed) and it matches the prefix.
 *
 * @param {object} params
 * @param {string} params.extPub serialized extended pub.
 * @param {number} params.coinType 44, 49 or 84 depending on the BIP used.
 * Optional if you don't want to check it.
 * @param {number} params.accountNumber Integer >= 0 corresponding to the account
 * number serialized in the extPub. Optional if you don't want to check it.
 * @param {Object} params.network A {@link module:networks.networks network}.
 */
export function checkExtPub({ extPub, coinType, accountNumber, network }) {
  if (
    typeof extPub !== 'string' ||
    (extPub.length === 111 || extPub.length === 112) === false
  )
    throw new Error('Invalid extPub!');
  const extPubType = extPub.slice(0, 4);
  if (
    extPubType !== XPUB &amp;&amp;
    extPubType !== YPUB &amp;&amp;
    extPubType !== ZPUB &amp;&amp;
    extPubType !== TPUB &amp;&amp;
    extPubType !== UPUB &amp;&amp;
    extPubType !== VPUB
  )
    throw new Error('Invalid extPub. Pub type must be x/y/z/t/u/vpub!');

  checkNetwork(network);

  let _coinType = getNetworkCoinType(network);
  const networkId = getNetworkId(network);
  //    throw new Error(
  //      'Invalid extPub. This wallet assumes Bitcoin mainnet, testnet or regtest only!'
  //    );
  if (!Object.values(EXTENDEDPUBTYPES[networkId]).includes(extPubType))
    throw new Error(
      'Invalid extPub. The prefix of the extPub does not match with the network!' +
        ':' +
        extPubType +
        ':' +
        network.bip32.public
    );
  if (typeof coinType !== 'undefined')
    if (coinType !== _coinType)
      throw new Error('Invalid extPub. coinType does not match!');
  coinType = _coinType;

  //Convert the extPub to "xpub" prefixed. This is the way bip32 nodejs module
  //internally works
  let data = b58.decode(extPub);
  data = data.slice(4);
  data = Buffer.concat([
    Buffer.from(
      PUBVERSIONS[networkId][LEGACY].toString(16).padStart(PUBVERSIONSIZE, 0),
      'hex'
    ),
    data
  ]);
  const xpubPrefixedExtPub = b58.encode(data);

  //Do the slice thing.
  //check network
  //do a setExtPubPrefix and then do a fromBase58
  //fromBase58 does already a series of checks and throws if it fails.
  const hd = bjsBip32.fromBase58(xpubPrefixedExtPub, network);
  if (hd.depth !== 3) {
    throw new Error('Invalid extPub. This wallet assumes extPub with depth 3!');
  }
  if (typeof accountNumber !== 'undefined') {
    if ((hd.index &amp; 0x7fffffff) /*unharden*/ !== accountNumber)
      throw new Error('Invalid extPub. accountNumber mismatch!');
  }
  return true;
}

/**
 * Throws an error if the address or the network is not valid.
 *
 * Based on: [https://github.com/bitcoinjs/bitcoinjs-lib/issues/890](https://github.com/bitcoinjs/bitcoinjs-lib/issues/890)
 * @param {string} address Bitcoin address.
 * @param {Object} network A {@link module:networks.networks network}.
 * @returns {boolean} If the function does not throw, then it always returns true.
 */
export function checkAddress(address, network) {
  checkNetwork(network);
  try {
    bjsAddress.toOutputScript(address, network);
    return true;
  } catch (e) {
    throw new Error('Invalid address');
  }
}

/**
 * Throws an error if feeEstimates do not respect Esplora format.
 *
 * See [`/fee-estimates`](https://github.com/Blockstream/esplora/blob/master/API.md#get-fee-estimates).
 *
 * @param {Object} feeEstimates An object where the key is the confirmation target (in number of blocks - an integer)
 * and the value is the estimated feerate (in sat/vB).
 * For example:
 * ```
 * { "1": 87.882, "2": 87.882, "3": 87.882, "4": 87.882, "5": 81.129, "6": 68.285, ..., "144": 1.027, "504": 1.027, "1008": 1.027 }
 * ```
 * @returns {boolean} If the function does not throw, then it always returns true.
 */
export function checkFeeEstimates(feeEstimates) {
  const error = 'Invalid esplora fee estimates!';
  if (
    typeof feeEstimates !== 'object' ||
    Object.keys(feeEstimates).length === 0
  ) {
    throw new Error(error);
  }
  Object.keys(feeEstimates).map(key => {
    if (
      typeof key !== 'string' ||
      !Number.isInteger(Number(key)) ||
      Number(key) &lt;= 0 ||
      typeof feeEstimates[key] !== 'number' ||
      feeEstimates[key] &lt; 0
    ) {
      throw new Error(error);
    }
  });
  return true;
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Wed Oct 19 2022 20:34:27 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
